<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">

<html>
<head>
  <title>Pig Tutorial</title>
</head>

<body>
  <h1>Pig Tutorial</h1>

  <h2>Goals:</h2>

  <ol>
    <li>Create Ssh Connections to remote servers </li>

    <li>Copy files from remote servers to Hadoop File system</li>

    <li>Build workflows that perform queries using multiple data sets</li>

    <li>Learn how to use some of the actions that are available in the Pig Package</li>
  </ol>

  <h2>Pig Workflow</h2>

  <h3>Copying file from a Remote to HDFS</h3>

  <p>The purpose of this task is to demonstrate the 'Remote File System' functionality.
  </p>
  <p>
  It will show how to connect to remote servers and copy files from the remote server to the Hadoop file system.
  </p>

  <ol>
    <li>Here is what your workspace should look like at the beginning of this tutorial.</li>
    <img src="../helpimages/pigtutorial-copy-1.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:800px;"
                            title="Screen Start"/>
    <li>Next to Canvases, Click on the arrow down, and choose Remote File Systems.</li>
    <img src="../helpimages/pigtutorial-copy-1.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:800px;"
                            title="Add Remote File Systems"/>
    <img src="../helpimages/pigtutorial-copy-1-after.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:800px;"
                            title="What you should see once added"/>
    <li>Go in Main Settings.</li>
    <img src="../helpimages/pigtutorial-copy-2.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:500px;"
                            title="Setting Menu Position"/>
    <li>Go to remotefs &gt; host (left menu)</li>
    <img src="../helpimages/pigtutorial-copy-3.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="The Setting Page"/>
    <li>Click the plus symbol and type “local” in the text box</li>
    <img src="../helpimages/pigtutorial-copy-4.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Add a template"/>
    <li>Click on local and fill out the host to be localhost, your user name and password (remove the private key file property)</li>
    <img src="../helpimages/pigtutorial-copy-5.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Fill out the settings"/>
    <li>Click the Check button, you should get success.</li>
    <img src="../helpimages/pigtutorial-copy-6.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Check the settings"/>
    <li>Leave Settings and refresh the Remote File Systems. You should see the local connection now.</li>
    <img src="../helpimages/pigtutorial-copy-7.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:300px;"
                            title="Refresh Remote File Systems"/>
    <li>    From the remote file system tab, you should navigate to '/${redsqirl_home}/tutorialdata/' directory. For example, Red Sqirl in this tutorial is installed in /local/usr/share/redsqirl</li>
    <img src="../helpimages/pigtutorial-copy-8.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Navigate to the tutorialdata directory"/>
    <li>Add the Hadoop File System tab, to the right, next to Help.</li>
    <img src="../helpimages/pigtutorial-copy-9.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:800px;"
                            title="Add the Hadoop File System Tab"/>
    <li>Drag the file 'pig_tutorial_data.txt' to the hadoop file system tab.</li>
    <img src="../helpimages/pigtutorial-copy-10.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:800px;"
                            title="Copy the file to Hadoop"/>
    <li>Click the plus symbol to create a new directory on hadoop file system and give it the name 'pig_tutorial_data.mrtxt'.</li>
    <img src="../helpimages/pigtutorial-copy-11.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Create a directory on Hadoop"/>
    <li>Click the checkbox beside the 'pig_tutorial_data.txt' file and then click the move symbol under the current working directory.</li>
    <img src="../helpimages/pigtutorial-copy-12.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Select a file"/>
    <li>In the new window, click the radio button beside 'pig_tutorial_data.mrtxt' folder and click ok</li>
    <img src="../helpimages/pigtutorial-copy-13.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Move a file selected"/>
 
  </ol>

  <h3>Create a Workflow</h3>

  <h4>Setup a Source Action</h4>

  <p>This task will show how the source 'action' can be configured to select flat files and change the properties such as the delimiter of the file and also the headings and types of the file.</p>

  <ol>
    <li>In the actions footer, drag a new Pig Text Source icon onto the canvas.</li>
    <li>Double click to open source.</li>
    <li>Name the action &ldquo;communication&ldquo;.</li>
    <li>Comment the action &ldquo;Configure tutorial data&ldquo;.</li>
    <img src="../helpimages/pigtutorial-source-4.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Name & Coment an action"/>
    <li>Click ok.</li>

    <li>On the data set screen, click on the path field or on the <img src="../image/icons/button-search.gif" style="margin:0px"/> button.</li>

    <li>Click on the radio button beside &ldquo;pig_tutorial_data.mrtxt&rdquo;</li>
    <img src="../helpimages/pigtutorial-source-7.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Select a directory"/>

    <li>Click ok.</li>
    <li>On the feature title line, click on the edit button.</li>
    <img src="../helpimages/pigtutorial-source-9.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Edit Header"/>
    <li>Once it appears choose &ldquo;Change Header&rdquo;</li>
    <li>Copy and paste &ldquo;subscriber_number STRING , Friend STRING ,
    offpeak_voice INT , offpeak_sms INT , offpeak_mms INT
    ,peak_voice INT,peak_sms INT , peak_mms INT , sna_weight INT ,
    subscriber_onnet INT ,friend_onnet INT&rdquo; into the value
    field.</li>
    <li>Click ok. The user will have the confirmation that the header is correct.</li>

    <li>Click ok to exit from the configuration window.</li>

    <li>If the user hovers over the source action and hits ctrl, some configuration details will appear</li>
    <img src="../helpimages/pigtutorial-source-14.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:300px;"
                            title="Action Details"/>

    <li>Save the Workflow by going into File &gt; Save, name it
    &ldquo;pig_tutorial&rdquo;. By default it is saved in redsqirl-save HDFS
    directory and the file will have the extension &lsquo;.rs&rsquo;. Click ok
    to save.</li>
    <img src="../helpimages/pigtutorial-source-15.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Save Workflow Page"/>


  </ol>


  <h4>Setup nl_sum Action</h4>

  <p> Pig Aggregator is an action in which aggregation methods are allowed to be
  used when selecting columns as you would in an sql statement.  These
  aggregation methods are AVG , MAX , SUM etc. This action will group by either
  the selected attributes or all (default if none is selected).</p>

  <ol>
    <li>Drag a pig aggregator action to the
    canvas.</li>

    <li>Create a link between the source that was just configured and the new
    pig aggregator action by clicking between the image and the arc of the
    source action and then clicking on the pig aggregator image.</li>

    <li>Open the new pig aggregator click, name the element &ldquo;nl_sum&rdquo;
    and Click ok.</li>
    <img src="../helpimages/pigtutorial-agg-3.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:300px;"
                            title="Name Aggregator Action"/>

    <li>Select
    &ldquo;subscriber_number&rdquo; and  click "Select" in the Group by
    interaction.</li>
    <img src="../helpimages/pigtutorial-agg-4.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Aggregator Action: Group page"/>

    <li>Click next.</li>

    <li>Select the copy from the dropdown menu
    on the generator interaction and click ok.</li>
    <img src="../helpimages/pigtutorial-agg-6.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Aggregator Action: Group page"/>

    <li>On the top of the table click the
    &ldquo;+&rdquo; symbol to add a new row to the
    table.</li>

    <li>Click on the pen in Operation field of the new
    row and click the &ldquo;SUM()&rdquo; function and add the
    parameters &ldquo;offpeak_voice&rdquo; and
    &ldquo;peak_voice&rdquo;. In between the parameters add a
    &ldquo;+&rdquo; symbol so that the operation would read
    &ldquo;SUM(offpeak_voice + peak_voice)&rdquo;</li>
    <img src="../helpimages/pigtutorial-agg-8.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="total_voice calculation"/>

    <li>click ok.</li>
    <li>In the Field Name, type
    &ldquo;total_voice&rdquo; for the new column and change
    the type to DOUBLE.</li>
    <img src="../helpimages/pigtutorial-agg-10.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="nl_sum operations"/>

    <li>Click ok.</li>

    <li>In &ldquo;Project&rdquo; menu on the top, click &ldquo;Save and Run&rdquo; to run the workflow.</li>
    <img src="../helpimages/pigtutorial-agg-12.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Save and Run"/>

    <li>To see the results, hover over the action &ldquo;nl_sum&rdquo; and click ctrl, &gt; Options &gt; Data
    Output.</li>
    <img src="../helpimages/pigtutorial-agg-13.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Browse output"/>
    <li>You can close it by clicking &ldquo;Cancel&rdquo; or &ldquo;ok&rdquo;</li>
  </ol>

  <h4>Setup comm_groupbyall Action</h4>

  <ol>
    <li>Drop another pig aggregator onto the
    canvas.</li>

    <li>Make a link between the source and the new pig aggregator.</li>

    <li>Open it, and give it the name "comm_groupbyall" and click ok.</li>
    <img src="../helpimages/pigtutorial-aggall-3.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:300px;"
                            title="Name the action"/>

    <li>This time leave the group by list alone so nothing is selected and click
    next.</li>
    <img src="../helpimages/pigtutorial-aggall-4.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Group Page"/>

    <li>Create a new row (+ button).</li>

    <li>In this new row copy and paste &ldquo;AVG(offpeak_voice +
    peak_voice)&rdquo;.</li>

    <li>Call the field &ldquo;total_voice_avg&rdquo; and select the DOUBLE type.</li>
    <img src="../helpimages/pigtutorial-aggall-7.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:600px;"
                            title="Operation Page"/>

    <li>Click bottom right ok button.</li>
  </ol>

  <h4>Perform a Pig Join Action</h4>

  <p> To make each dataset interactable with each other it is necessary to
  perform a join on them.</p>



  <ol>
    <li>Drop a pig join onto the canvas.</li>

    <li>Create a link from &ldquo;comm_groupbyall&rdquo; to the new
    pig join action.</li>

    <li>Create a link from &ldquo;nl_sum&rdquo; to the new
    pig join action.</li>
    <img src="../helpimages/pigtutorial-join-3.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:300px;"
                            title="Workflow so far"/>

    <li>Double click the pig join and call it &ldquo;nl_vs_total&rdquo;.</li>
    <img src="../helpimages/pigtutorial-join-4.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:300px;"
                            title="Name join action"/>

    <li>The first page list the table aliases, click next.</li>

    <li>On the following page, make sure that &ldquo;copy&rdquo; is selected as
    the generator and click ok.</li>
    <img src="../helpimages/pigtutorial-join-6.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Operation page"/>

    <li>Click next.</li>

    <li>This page has two interactions that
    specify the join type and the fields to join on, we use the
    default join type which is &ldquo;Join&rdquo; so this does not
    need to be changed.</li>

    <li>In &ldquo;Join Field&rdquo; column, type &ldquo;1&rdquo; in the two rows. This condition will join
    the two tables together.</li>
    <img src="../helpimages/pigtutorial-join-9.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Join Condition"/>

    <li>Click ok.</li>
  </ol>


  <h4>Filter a Data set</h4>

  <p> Now we want to make a condition to see what subscribers have a higher
  total voice calls than the average of the entire dataset. The easiest would be
  to add the condition in Join but we will create a new select for demonstration
  purposes.</p>


  <ol>
    <li>Drop a new pig filter action onto the canvas.</li>

    <li>Create a link from the pig join action
    to the new pig select action</li>

    <li>Open it and change the element id to be &ldquo;high_voice&rdquo;.</li>
    <img src="../helpimages/pigtutorial-filter-3.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Rename Actions"/>

    <li>Write 'nl_sum_total_voice &gt; comm_gball_total_voice_avg' in the text box</li>
    <img src="../helpimages/pigtutorial-filter-4.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Filter Condition"/>

    <li>Click ok.</li>

    <li>Cache 'nl_vs_total' intermediate result before running the workflow. Select 'nl_vs_total' and go into the top menu Edit &gt; Output State &gt; Buffered.</li>

    <li>On the top menu, go in Project &gt; Save and Run, and see the results in the data output of 'nl_vs_total' and 'high_voice'. </li>
    <img src="../helpimages/pigtutorial-filter-7.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Save and Run"/>
    <li>If the user won’t reuse the canvas or its data anymore, it is always recommended to clear the cache data. the data can be cleaned by clicking on 'Select All' and then 'Clean Actions' in the 'Edit' top menu.</li>

    <img src="../helpimages/pigtutorial-filter-8-step1.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Select All"/>

    <img src="../helpimages/pigtutorial-filter-8-step2.png" 
                style="width: 100%;  margin-left: 0.00px; margin-top: 0.00px;max-width:400px;"
                            title="Clean Actions"/>
  </ol>

  <h4>Summary of workflow</h4>

  <p>In this workflow we have</p>

  <ol>
    <li>Configured source for a hdfs file</li>

    <li>Selected the sum of two columns</li>

    <li>Calculated the average of a column</li>

    <li>Calculated the sum of a column when grouped</li>

    <li>Joined two tables</li>

    <li>Filtered a table</li>
  </ol>

</body>
</html>
